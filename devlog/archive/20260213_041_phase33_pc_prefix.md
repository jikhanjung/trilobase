# Phase 33: PaleoCore 쿼리 `pc.*` prefix 전환

**날짜:** 2026-02-13
**상태:** 완료

## 개요

Phase 32에서 paleocore.db를 `pc` alias로 ATTACH하는 인프라를 구축했다.
이번 Phase 33에서는 app.py와 mcp_server.py의 모든 PaleoCore 테이블 참조를
`pc.*` prefix로 전환하여, 쿼리가 paleocore.db에서 데이터를 읽도록 변경했다.

## 변경 내용

### app.py (16개 쿼리 수정)

| Route | 변경된 테이블 |
|---|---|
| `api_genus_detail` | `pc.formations`, `pc.geographic_regions`, `pc.temporal_ics_mapping`, `pc.ics_chronostrat` |
| `api_metadata` | `pc.formations`, `pc.geographic_regions` |
| `api_country_detail` | `pc.geographic_regions` (3개 쿼리) |
| `api_region_detail` | `pc.geographic_regions` |
| `api_chronostrat_detail` | `pc.ics_chronostrat` (3개), `pc.temporal_ics_mapping` (2개) |
| `api_formation_detail` | `pc.formations` |

### mcp_server.py (6개 쿼리 수정)

| Function | 변경된 테이블 |
|---|---|
| `build_genus_evidence_pack` | `pc.formations`, `pc.countries` |
| `get_metadata` | `pc.formations`, `pc.countries` |
| `get_genera_by_country` | `pc.countries` |
| `get_genera_by_formation` | `pc.formations` |

### trilobase.db

- `ui_queries` 테이블의 `ics_chronostrat_list` SQL을 `pc.ics_chronostrat`로 업데이트

### test_app.py

- test_db fixture에 test paleocore DB 생성 추가
- PaleoCore 테이블 5개 (countries, geographic_regions, formations, ics_chronostrat, temporal_ics_mapping) 데이터를 test paleocore DB에 삽입
- `_set_paths_for_testing(canonical, overlay, paleocore_path)` 3인자 호출
- 기존 2-tuple 언패킹 → 3-tuple로 전환 (27곳)

## 설계 결정

1. **Fallback 없음**: paleocore.db는 git 추적 중이므로 항상 존재
2. **trilobase.db 로컬 테이블 유지**: DROP하지 않음, 쿼리만 `pc.*` 전환
3. **Cross-DB JOIN 패턴**: Trilobase 테이블은 prefix 없이, PaleoCore 테이블은 `pc.*`

## 테스트

```
pytest test_app.py -v     # 147개 통과
pytest test_mcp.py -v     # 16개 통과
pytest test_mcp_basic.py  # 1개 통과
합계: 164개 전부 통과
```
