# P25: ICS Chronostratigraphy 웹 UI 추가

**날짜:** 2026-02-12

## Context

Phase 28에서 `ics_chronostrat`(178개)과 `temporal_ics_mapping`(40행) 테이블을 DB에 임포트 완료.
이제 웹 인터페이스에서:
1. Countries 탭처럼 **Chronostratigraphy 테이블 탭** 추가
2. 행 클릭 → **chronostrat unit detail 모달** (계층, 연대, 색상, 관련 genera)
3. Genus detail에서 **temporal_code → ICS unit 링크** 추가 (원본 코드 "LCAM" 등 유지하면서 매핑된 ICS unit으로 이동 가능)

## 수정 파일 (4개)

### 1. `app.py` — Flask API 2개 추가

**`/api/chronostrat/<id>` 라우트 추가** (country detail 패턴 따름):
- 기본 정보: id, name, rank, start_mya, end_mya, uncertainty, short_code, color, ratified_gssp
- 부모: parent (id, name, rank) — 클릭 가능
- 자식 목록: children (하위 계층 unit들)
- 관련 genera: `temporal_ics_mapping` → `temporal_ranges.code` = `taxonomic_ranks.temporal_code` 조인
- 매핑 정보: 이 unit에 매핑된 temporal_codes 목록 (mapping_type 포함)

**`/api/genus/<id>` 수정** (기존 genus detail API):
- `temporal_code`에 대응하는 ICS mapping 정보를 추가 반환
- 응답에 `temporal_ics_mapping` 필드 추가: `[{id, name, rank, mapping_type}]`

### 2. `static/js/app.js` — JavaScript 함수 추가

**`showChronostratDetail(id)` 함수 추가** (showCountryDetail 패턴 따름):
- 아이콘: `bi-clock-history`
- Basic Information: Name, Rank, Time Range, Short Code, Color (색상 칩), GSSP
- Hierarchy: 부모 링크 (클릭 → showChronostratDetail)
- Children 테이블: Name | Rank | Time Range (클릭 → showChronostratDetail)
- Mapped Temporal Codes: 매핑된 코드 목록 (MCAM, MUCAM 등 + mapping_type)
- Related Genera 테이블: Name | Author | Year | Temporal Code | Valid (클릭 → showGenusDetail)

**`renderTableViewRows` clickHandlers에 추가:**
- `'chronostratigraphy_table': (row) => \`onclick="showChronostratDetail(${row.id})"\``

**Genus detail Temporal Range 표시 수정:**
- 기존: plain text `LCAM`
- 변경: 원본 코드 유지 + ICS 매핑 링크들
  - `LCAM → Terreneuvian (partial), Series 2 (partial)`
  - 각 ICS 이름은 showChronostratDetail 클릭 가능 링크

### 3. `trilobase.db` — Named Query + Manifest 추가

**ui_queries:** `ics_chronostrat_list` 추가
**ui_manifest:** `chronostratigraphy_table` 뷰 추가 (columns: Name, Rank, Start Ma, End Ma, Color)

Color 컬럼은 색상 칩으로 특별 렌더링.

### 4. `test_app.py` — 테스트 추가

- `/api/chronostrat/<id>` 응답 구조 테스트
- Genus detail API의 `temporal_ics_mapping` 필드 테스트

## 구현 순서

1. `app.py`: `/api/chronostrat/<id>` 라우트 추가 + `/api/genus/<id>` 수정
2. `trilobase.db`: named query + manifest 갱신
3. `static/js/app.js`: showChronostratDetail + click handler + genus detail 수정 + color 렌더링
4. `test_app.py`: 테스트 추가
5. 전체 테스트 실행 확인
6. devlog/HANDOVER 갱신
