# Phase 32: Dual-DB 운영 (PaleoCore ATTACH)

**날짜:** 2026-02-13
**유형:** 작업 로그

---

## 목표

PaleoCore DB를 ATTACH하여 trilobase.db와 동시 운영. 레거시 컬럼 제거.

## 작업 내용

### 1. taxonomic_ranks 레거시 컬럼 삭제

`country_id`, `formation_id` 컬럼 제거 (Phase 10에서 junction table로 대체됨):
- 20 → 18 컬럼
- 5,340 레코드 유지, taxa 뷰 재생성

### 2. scoda_package.py 수정

- `_paleocore_db` 경로 변수 추가
- `_resolve_paths()`: paleocore.db 경로 자동 탐색 (dev/frozen 모드)
- `_set_paths_for_testing()`: paleocore_path 파라미터 추가
- `get_paleocore_db_path()`: 새 함수
- `get_db()`: paleocore.db를 `pc` alias로 ATTACH (파일 존재 시)
- `get_scoda_info()`: paleocore 경로/존재 여부 포함

### 3. Flask app 수정

- `GET /api/paleocore/status`: PaleoCore DB 상태 및 cross-DB 검증 엔드포인트
  - attached 여부, metadata, 테이블별 레코드 수
  - cross-DB JOIN 테스트 (genus_locations ↔ pc.countries)
- `GET /api/metadata`: `paleocore_attached` 필드 추가

### 4. test_app.py 수정

- test fixture에서 `country_id`, `formation_id` 컬럼 제거

## 결과

- trilobase.db: 18 컬럼 (country_id, formation_id 제거)
- 3개 DB 동시 ATTACH: main(trilobase.db) + overlay + pc(paleocore.db)
- Cross-DB JOIN 정상 동작:
  - genus_locations JOIN pc.countries: 4,841 rows
  - genus_formations JOIN pc.formations: 4,853 rows
  - taxonomic_ranks JOIN pc.temporal_ranges: 4,730 rows
- 테스트: 164개 전부 통과 (147 app + 17 MCP)

## 수정된 파일

- `trilobase.db` — taxonomic_ranks 레거시 컬럼 삭제
- `scoda_package.py` — paleocore.db ATTACH 로직
- `app.py` — `/api/paleocore/status` 엔드포인트, metadata에 paleocore 상태
- `test_app.py` — test fixture 스키마 갱신
