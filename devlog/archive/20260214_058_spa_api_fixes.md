# Reference SPA API 연동 수정

**날짜:** 2026-02-14
**유형:** Bugfix

## 배경

Phase 46 Step 3에서 legacy 엔드포인트 11개를 삭제한 후, Reference SPA가
데이터를 로드하지 못하는 문제 발견. 총 4건의 버그를 수정.

## 수정 내용

### 1. SPA API_BASE 변수 충돌 (SyntaxError)

- **증상**: `app.js` 전체 로드 실패, 모든 기능 미동작
- **원인**: `spa/index.html`에서 `const API_BASE` 선언 → `app.js`에서 `var API_BASE` 재선언 → JS에서 같은 스코프에 `const`와 `var` 공존 불가
- **수정**: `spa/index.html`의 `const` → `var` 변경

### 2. Manifest detail view source URL (404)

- **증상**: 모든 detail 모달에서 404 에러
- **원인**: manifest의 detail view `source` 필드가 삭제된 legacy URL 참조 (`/api/genus/{id}` 등)
- **수정**: 7개 detail view의 `source`를 `/api/composite/<view_name>?id={id}`로 전환

### 3. Manifest detail view composite 쿼리 미정의 (404)

- **증상**: composite endpoint가 `source_query` 없어서 404 반환
- **원인**: Phase 46 Step 1에서 추가한 `source_query`, `source_param`, `sub_queries`가 실제 DB에 미반영
- **수정**:
  - Named query 17개 추가 (detail source + sub-query용)
  - Manifest detail view 7개에 `source_query`, `source_param`, `sub_queries` 추가

**추가된 named queries (17개):**
- genus_hierarchy, genus_ics_mapping
- rank_children, rank_children_counts
- country_detail, country_regions, country_genera
- region_detail, region_genera
- formation_detail, formation_genera
- bibliography_detail, bibliography_genera
- chronostrat_detail, chronostrat_children, chronostrat_mappings, chronostrat_genera

### 4. genus_locations 쿼리 country/region ID 불일치 (undefined 표시)

- **증상**: Genus detail Geographic Information에서 country가 "undefined" 또는 잘못된 국가 표시
- **원인**: `genus_locations` named query가 `pc.countries` 테이블로 JOIN했지만, SPA는 `pc.geographic_regions` 기반의 `country_id`, `country_name`, `region_id`, `region_name` 필드를 기대
- **수정**: `genus_locations` 쿼리를 `pc.geographic_regions` 기반으로 전환
  - `genus_locations.region_id` → `pc.geographic_regions` JOIN
  - region-level: parent가 country, region-level: 자신이 region
  - country-level: 자신이 country, region은 NULL

## 변경 파일

- `spa/index.html`: `const API_BASE` → `var API_BASE`
- `trilobase.db`:
  - `ui_manifest`: detail view 7개 source URL + composite 쿼리 설정
  - `ui_queries`: named query 17개 추가, genus_locations SQL 수정
