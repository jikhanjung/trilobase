# Phase 29: ICS Chronostratigraphy Web UI

**날짜:** 2026-02-12
**상태:** 완료

## 목표

Phase 28에서 임포트한 `ics_chronostrat`(178개)과 `temporal_ics_mapping`(40행) 데이터를 웹 UI에서 탐색할 수 있도록 추가.

## 변경 내역

### 1. `app.py` — API 추가/수정

**`/api/chronostrat/<id>` 신규:**
- 기본 정보: name, rank, start_mya, end_mya, uncertainty, short_code, color, ratified_gssp
- parent: 상위 계층 unit (클릭 가능)
- children: 하위 계층 unit 목록
- mappings: 이 unit에 매핑된 temporal_codes 목록 (mapping_type 포함)
- genera: temporal_ics_mapping → taxonomic_ranks 조인으로 관련 genera 목록

**`/api/genus/<id>` 수정:**
- `temporal_ics_mapping` 필드 추가: temporal_code에 대응하는 ICS unit 목록
- 각 항목: id, name, rank, mapping_type

### 2. `trilobase.db` — Named Query + Manifest 갱신

**ui_queries 추가:**
- `ics_chronostrat_list`: 전체 ICS 목록 (display_order 정렬)

**ui_manifest 갱신:**
- `chronostratigraphy_table` 뷰 추가
- 컬럼: Name, Rank, Start (Ma), End (Ma), Color (color chip 렌더링)
- 아이콘: bi-clock-history

### 3. `static/js/app.js` — 프론트엔드

**`showChronostratDetail(id)` 함수 신규:**
- Basic Information: Name, Rank, Time Range, Short Code, Color (chip), GSSP
- Hierarchy: parent 링크 (클릭 → showChronostratDetail)
- Children 테이블: Name | Rank | Time Range | Color (클릭 → showChronostratDetail)
- Mapped Temporal Codes: 매핑된 코드 목록 (mapping_type 표시)
- Related Genera 테이블: Name | Author | Year | Temporal Code | Valid (클릭 → showGenusDetail)

**clickHandlers 추가:**
- `chronostratigraphy_table` → `showChronostratDetail`

**Color 컬럼 렌더링:**
- `type: "color"` 컬럼은 색상 chip + hex 값으로 표시

**Genus detail Temporal Range 개선:**
- `buildTemporalRangeHTML(g)` 함수 추가
- 원본 코드 `LCAM` 유지 + ICS mapping 링크 표시
- 예: `UCAM → Furongian`

### 4. `static/css/style.css` — 색상 chip 스타일

- `.color-chip` 클래스 추가 (16x16px, rounded, border)

### 5. `test_app.py` — 테스트 추가

**TestApiChronostratDetail (12개):**
- basic info, parent, no parent, children, children structure
- mappings, mapping types, genera, genera structure
- response structure, query execute

**TestGenusDetailICSMapping (4개):**
- has temporal_ics_mapping field
- Olenus → Furongian mapping
- structure validation
- no match (empty list)

**기존 테스트 업데이트:**
- manifest view count: 4 → 5
- queries count: 5 → 6
- test fixture에 ics_chronostrat_list query + chronostratigraphy_table manifest 추가

## 테스트 결과

```
145 passed in 37.55s
```

## 수정 파일 목록

| 파일 | 변경 |
|------|------|
| `app.py` | `/api/chronostrat/<id>` 신규, `/api/genus/<id>` temporal_ics_mapping 추가 |
| `trilobase.db` | ics_chronostrat_list query, chronostratigraphy_table manifest 추가 |
| `static/js/app.js` | showChronostratDetail, buildTemporalRangeHTML, color rendering, click handler |
| `static/css/style.css` | .color-chip 스타일 |
| `test_app.py` | 16개 테스트 추가, 기존 테스트 카운트 업데이트 |
